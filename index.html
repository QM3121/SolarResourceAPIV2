<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Solar Resource Viewer</title>
  <link
    rel="stylesheet"
    href="https://js.arcgis.com/4.25/esri/themes/light/main.css"
  />
  <script src="https://js.arcgis.com/4.25/"></script>
  <style>
    html, body, #viewDiv {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body>
  <div id="viewDiv"></div>
  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/Graphic"
    ], function (Map, MapView, Graphic) {
      const apiKey = "ZTxykdcgo6jCUJMv88T7JcKbmZGjIyBeWd4dAXY9";

      const map = new Map({
        basemap: "satellite"
      });

      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-99.9018, 31.9686],
        zoom: 6
      });

      // Add reference labels layer for 'hybrid' appearance
      view.map.basemap.referenceLayers = [{
        portalItem: {
          id: "10df2279f9684e4a9f6a7f08febac2a9"
        }
      }];

      // PVWatts parameters
      const system_capacity = 100000; // 250 MW
      const azimuth = 180;
      const tilt = 30;
      const array_type = 2; // Fixed open rack
      const module_type = 1; // Standard
      const losses = 22.5;

      view.on("click", function (event) {
        const lat = event.mapPoint.latitude;
        const lon = event.mapPoint.longitude;

        const url = `https://developer.nrel.gov/api/pvwatts/v6.json?api_key=${apiKey}&lat=${lat}&lon=${lon}&system_capacity=${system_capacity}&azimuth=${azimuth}&tilt=${tilt}&array_type=${array_type}&module_type=${module_type}&losses=${losses}`;

        fetch(url)
          .then(response => response.json())
          .then(data => {
            if (data.outputs) {
              const ac_annual = data.outputs.ac_annual;
              const dc_monthly = data.outputs.dc_monthly;
              const solrad_annual = data.outputs.solrad_annual;

              const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                                  "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

              const monthlyStr = Array.isArray(dc_monthly)
                ? dc_monthly.map((val, i) => `${monthNames[i]}: ${(val / 1000).toFixed(1)} MWh`).join("<br>")
                : "N/A";

              view.graphics.removeAll();

              const pointGraphic = new Graphic({
                geometry: event.mapPoint,
                symbol: {
                  type: "simple-marker",
                  color: "yellow",
                  size: "12px",
                  outline: {
                    color: "black",
                    width: 1
                  }
                },
                popupTemplate: {
                  title: `Solar Output at [${lat.toFixed(4)}, ${lon.toFixed(4)}]`,
                  content: `
                    <b>Annual AC Output:</b> ${(ac_annual / 1000).toFixed(1)} MWh<br/>
                    <b>Annual Solar Irradiation:</b> ${solrad_annual.toFixed(2)} kWh/mÂ²/day<br/>
                    <b>Monthly DC Output:</b><br/>${monthlyStr}
                  `
                }
              });

              view.graphics.add(pointGraphic);
              view.popup.open({
                location: event.mapPoint,
                title: pointGraphic.popupTemplate.title,
                content: pointGraphic.popupTemplate.content
              });
            } else {
              alert("No solar data available for this location.");
            }
          })
          .catch(err => {
            console.error(err);
            alert("Error retrieving solar resource data.");
          });
      });
    });
  </script>
</body>
</html>



